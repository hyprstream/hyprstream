name: Build AppImage

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  LIBTORCH_VERSION: "2.10.0"
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  # Build all backend variants sequentially on a single runner
  # This maximizes sccache hits and minimizes disk usage
  build-all-variants:
    name: Build all variants (sequential)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            capnproto \
            libssl-dev \
            libsystemd-dev \
            pkg-config \
            build-essential

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: cargo-${{ runner.os }}-sequential-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-sequential-
            cargo-${{ runner.os }}-

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [[ "$VERSION" == "$GITHUB_REF_NAME" ]] && VERSION="dev"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build CPU AppImage
        run: |
          ./appimage/build-appimage.sh build cpu --version ${{ steps.version.outputs.version }}
          ./appimage/build-appimage.sh clean cpu

      - name: Upload CPU AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-cpu
          path: appimage/output/*-cpu-*.AppImage
          retention-days: 5

      - name: Build CUDA 12.8 AppImage
        run: |
          ./appimage/build-appimage.sh build cuda128 --version ${{ steps.version.outputs.version }}
          ./appimage/build-appimage.sh clean cuda128

      - name: Upload CUDA 12.8 AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-cuda128
          path: appimage/output/*-cuda128-*.AppImage
          retention-days: 5

      - name: Build CUDA 13.0 AppImage
        run: |
          ./appimage/build-appimage.sh build cuda130 --version ${{ steps.version.outputs.version }}
          ./appimage/build-appimage.sh clean cuda130

      - name: Upload CUDA 13.0 AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-cuda130
          path: appimage/output/*-cuda130-*.AppImage
          retention-days: 5

      - name: Build ROCm 7.1 AppImage
        run: |
          ./appimage/build-appimage.sh build rocm71 --version ${{ steps.version.outputs.version }}
          ./appimage/build-appimage.sh clean rocm71

      - name: Upload ROCm 7.1 AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-rocm71
          path: appimage/output/*-rocm71-*.AppImage
          retention-days: 5

      - name: Build Universal AppImage
        run: |
          ./appimage/build-appimage.sh build universal --version ${{ steps.version.outputs.version }}

      - name: Upload Universal AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-universal
          path: appimage/output/hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage
          retention-days: 5

      - name: Show sccache stats
        run: sccache --show-stats

  # Create GitHub Release with all AppImages (tags only)
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-all-variants
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all AppImages
        uses: actions/download-artifact@v4
        with:
          pattern: appimage-*
          path: appimages/
          merge-multiple: true

      - name: List AppImages
        run: |
          echo "AppImages to release:"
          ls -lh appimages/

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate checksums
        run: |
          cd appimages
          sha256sum *.AppImage > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Hyprstream v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            appimages/*.AppImage
            appimages/SHA256SUMS.txt
          body: |
            ## AppImage Downloads

            | File | Description |
            |------|-------------|
            | `hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage` | Universal (auto-detects GPU) |
            | `hyprstream-${{ steps.version.outputs.version }}-cpu-x86_64.AppImage` | CPU only |
            | `hyprstream-${{ steps.version.outputs.version }}-cuda128-x86_64.AppImage` | NVIDIA CUDA 12.8 |
            | `hyprstream-${{ steps.version.outputs.version }}-cuda130-x86_64.AppImage` | NVIDIA CUDA 13.0 |
            | `hyprstream-${{ steps.version.outputs.version }}-rocm71-x86_64.AppImage` | AMD ROCm 7.1 |

            ### Usage

            ```bash
            # Download and make executable
            chmod +x hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage

            # Run (auto-detects GPU)
            ./hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage server

            # Override backend detection
            HYPRSTREAM_BACKEND=cuda130 ./hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage server

            # List available backends (universal only)
            ./hyprstream-${{ steps.version.outputs.version }}-x86_64.AppImage --list-backends
            ```

            ### GPU Requirements

            - **CUDA 12.8**: NVIDIA driver 535+
            - **CUDA 13.0**: NVIDIA driver 555+
            - **ROCm 7.1**: AMD GPU with ROCm 7.x installed

      - name: Cleanup artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: appimage-*
